---
import type { PropertyFilters } from '../types/property';

export interface Props {
  filters: PropertyFilters;
  total: number;
}

const { filters, total } = Astro.props;

const propertyTypes = [
  { value: 'apartamento-colonial', label: 'Apartamento Colonial' },
  { value: 'casa-independiente', label: 'Casa Independiente' },
  { value: 'villa-playa', label: 'Villa en la Playa' },
  { value: 'penthouse', label: 'Penthouse / Ático' },
  { value: 'palacete', label: 'Palacete / Mansión' },
];

const locations = ['Miramar', 'Vedado', 'Habana Vieja', 'Centro Habana', 'Cerro', 'Siboney'];

const hasActiveFilters =
  filters.minPrice || filters.maxPrice || filters.type || filters.location || filters.bedrooms;
---

<!-- Botón para abrir el drawer -->
<div class="flex items-center gap-4 mb-8">
  <button
    id="open-filters"
    type="button"
    class="flex items-center gap-2 px-5 py-3 border-2 border-primary text-primary font-bold uppercase tracking-wider text-sm hover:bg-primary hover:text-white transition-all"
  >
    <span class="material-symbols-outlined">tune</span>
    Filtros
    {
      hasActiveFilters && (
        <span class="size-5 bg-cuba-red text-white text-[10px] font-bold rounded-full flex items-center justify-center">
          ●
        </span>
      )
    }
  </button>

  {
    hasActiveFilters && (
      <a
        href="/propiedades"
        class="text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-cuba-red transition-colors flex items-center gap-1"
      >
        <span class="material-symbols-outlined text-sm">close</span>
        Limpiar filtros
      </a>
    )
  }

  <span class="text-sm font-serif italic text-gray-400 ml-auto">
    {total}
    {total === 1 ? 'propiedad' : 'propiedades'}
  </span>
</div>

<!-- Overlay -->
<div
  id="filter-overlay"
  class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300"
>
</div>

<!-- Drawer -->
<div
  id="filter-drawer"
  class="fixed top-0 right-0 h-full w-full max-w-sm bg-white z-50 shadow-2xl transform translate-x-full transition-transform duration-300 overflow-y-auto"
>
  <!-- Drawer Header -->
  <div
    class="flex items-center justify-between p-6 border-b-2 border-sea-glass sticky top-0 bg-white z-10"
  >
    <h2 class="text-xl font-serif font-bold italic">Refinar Búsqueda</h2>
    <button id="close-filters" type="button" class="p-2 hover:text-cuba-red transition-colors">
      <span class="material-symbols-outlined">close</span>
    </button>
  </div>

  <!-- Drawer Content -->
  <form method="GET" action="/propiedades" class="p-6 space-y-8">
    <!-- Precio -->
    <div>
      <label class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4 block">
        Presupuesto (USD)
      </label>
      <div class="flex items-center gap-2">
        <input
          name="minPrice"
          type="number"
          value={filters.minPrice || ''}
          placeholder="Mín"
          class="w-full bg-white border-gray-200 text-sm py-2 px-3 focus:ring-sea-glass focus:border-sea-glass"
        />
        <span class="text-gray-300">—</span>
        <input
          name="maxPrice"
          type="number"
          value={filters.maxPrice || ''}
          placeholder="Máx"
          class="w-full bg-white border-gray-200 text-sm py-2 px-3 focus:ring-sea-glass focus:border-sea-glass"
        />
      </div>
    </div>

    <!-- Tipo de Inmueble -->
    <div>
      <label class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4 block">
        Tipo de Inmueble
      </label>
      <div class="space-y-3">
        {
          propertyTypes.map((type) => (
            <label class="flex items-center gap-3 cursor-pointer group">
              <input
                type="checkbox"
                name="type"
                value={type.value}
                checked={filters.type === type.value}
                class="rounded-none border-gray-300 text-sea-glass focus:ring-sea-glass size-4"
              />
              <span class="text-sm font-serif italic text-gray-700 group-hover:text-primary">
                {type.label}
              </span>
            </label>
          ))
        }
      </div>
    </div>

    <!-- Ubicación -->
    <div>
      <label class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4 block">
        Ubicación
      </label>
      <div class="space-y-3">
        <label class="flex items-center gap-3 cursor-pointer group">
          <input
            type="radio"
            name="location"
            value=""
            checked={!filters.location}
            class="border-gray-300 text-sea-glass focus:ring-sea-glass size-4"
          />
          <span class="text-sm font-serif italic text-gray-700 group-hover:text-primary">
            Todas las zonas
          </span>
        </label>

        {
          locations.map((loc) => (
            <label class="flex items-center gap-3 cursor-pointer group">
              <input
                type="radio"
                name="location"
                value={loc}
                checked={filters.location === loc}
                class="border-gray-300 text-sea-glass focus:ring-sea-glass size-4"
              />
              <span class="text-sm font-serif italic text-gray-700 group-hover:text-primary">
                {loc}
              </span>
            </label>
          ))
        }
      </div>
    </div>

    <!-- Habitaciones -->
    <div>
      <label class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4 block">
        Habitaciones mínimas
      </label>
      <div class="flex gap-2">
        {
          [1, 2, 3, 4, 5].map((num) => (
            <button
              type="submit"
              name="bedrooms"
              value={num}
              class={`flex-1 py-2 text-sm font-bold border transition-colors ${
                filters.bedrooms === num
                  ? 'bg-primary text-white border-primary'
                  : 'border-gray-200 hover:border-sea-glass hover:text-sea-glass'
              }`}
            >
              {num}+
            </button>
          ))
        }
      </div>
    </div>

    <!-- Botón aplicar -->
    <button
      type="submit"
      class="w-full bg-primary text-white font-serif italic text-lg py-4 px-6 hover:bg-sea-glass hover:text-primary transition-all shadow-lg flex items-center justify-center gap-2"
    >
      Aplicar Filtros
      <span class="material-symbols-outlined text-sm">arrow_forward</span>
    </button>
  </form>
</div>

<script>
  const openBtn = document.getElementById('open-filters');
  const closeBtn = document.getElementById('close-filters');
  const drawer = document.getElementById('filter-drawer');
  const overlay = document.getElementById('filter-overlay');

  function openDrawer() {
    overlay?.classList.remove('hidden');
    setTimeout(() => {
      overlay?.classList.remove('opacity-0');
      drawer?.classList.remove('translate-x-full');
    }, 10);
    document.body.style.overflow = 'hidden';
  }

  function closeDrawer() {
    overlay?.classList.add('opacity-0');
    drawer?.classList.add('translate-x-full');
    setTimeout(() => {
      overlay?.classList.add('hidden');
    }, 300);
    document.body.style.overflow = '';
  }

  openBtn?.addEventListener('click', openDrawer);
  closeBtn?.addEventListener('click', closeDrawer);
  overlay?.addEventListener('click', closeDrawer);

  // Abrir automáticamente si hay filtros activos
  const urlParams = new URLSearchParams(window.location.search);
  const hasFilters =
    urlParams.has('minPrice') ||
    urlParams.has('maxPrice') ||
    urlParams.has('type') ||
    urlParams.has('location') ||
    urlParams.has('bedrooms');

  if (hasFilters) {
    // (misma lógica: simplemente lo dejas preparado; aquí lo abrimos)
    openDrawer();
  }
</script>
